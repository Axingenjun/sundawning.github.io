<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <title>
      White3DTilesetStyle - LINEARtoSRGB -
      model._rendererResources.sourceShaders - 仿百度 - 上海市区城市白模
    </title>
    <link
      rel="shortcut icon"
      href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAJAAAACQBAMAAAAVaP+LAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAAhUExUReHY5f///y8qMS0oL/Hu8khCSdHL02ZgZ4R9hKGaobqzux+9hjkAAASdSURBVGje7ZrPa9xGFMefQW0Tn9Yg3NrHGYzXVw3CuS4IJ+5xl7aOT7q0TXwqMWmcnoxNkm1PJtA46WkpmLr9K7vSajS/3ozmSb6Ues7io/f9zpufb2Djjhrcg+5B/1dQOrkDUFGsf/p49iEpiiGg4uTvd6+mjIud30qADpgflD5/OWVCCMYYz3+Buk16gA6upyJjTeP567ImFWTQ1294i6lIWUNKJjTQwxeCGa2ThILSZ1OLU5EanzxGYaDRX9OMOY3nbxtSEQlKrznCWZJ2ywAJAT3BOYy14jB1LmjzhYfDWL6QpAhQeuPlMP5UgpJu0APO/C2/8oqDeGFVSOPSR4J4YbXfb33iwO6xIEdLATskIAirQ/oZ8J4DijAzpMQPOuSssymXwA/qDmgZ0l4LWvOBNmcsoqn0TnygL7IYEFd2T3BQesGiQEpbgoO2eBSI7ZdYSECzum7nYVCc1ZW2Y0ybAj2ODQjXBkSr65y8QkICqtWVtm/BzW4gW71sY3C1SdBoFs/RTUps0BaBo40SpQ1Iw0O2K1ebBL2ncPhP4EwBDSg9JYG0bktM0DYngY69oMcki5iaAFqTgJ5FZiKZoPSSxNETSboNtJEvE6l0TFqBvmJE0MID+oxmEcsWjklAT8cAiJaONmhNgaheGx41Jq1A/I5A24z17/5mJoE+ve8HEXvfyOym28A/ZLkQGRc4CHAQmo8i++ZsPn/JKaDvEZDY+fWHpYCTN3wYiO9+WH21fpGF56MmI2vQn5mXA/BwFpwhDZC7Wudqpwi/Z4G9lgm69B86qpB4aDmSqV2DToND4PPTcBop0Og07MH7zLv5M0HO4M/N0H/Mghb5QfYfH4T/sxpsKMj6o+32GCIjMqyucnIW/I8/IkuZ3W32fxRo1PXHy0CX6tKsuT+zvQRjCDlWawl5GUo3q/+NpA+C7M633Hbj1UAXYYsAbtqJUrgBaSDDA+SXsC7PuuK7RQhkTGx56X4Kz2ZZffVzhHC0acSYs/cBa7dTIcTOGcbRQMYq8ggFwfP52fyPEsKgLyNAgTbBF8ghIOP8MARk7EYGgWaDQGoTMborkLGMkEGJZzM6poLWPNvjvV5eN6AtNgDkO0KMe1kkDzXajLQ7BKQfs/Kyj0XIwW8YSDuKZos+yrDD8fkQkJaS/LyPMuQCQT+L9wBtBZbkGGUtSEvJ8SDQhtrf7Zc9lCnQk+AK2RmQAqkdKbZmE0BqueV7PZRpoO0Z3ST0+jBt7c7OaZOjfTPaXtPHZxJ+V6vsfkRXZlxDtzu8/IpqtediPDYBOq/q+ZhqtQVqr1nzBVWZVc6QGRClLVDO2DiULo1LYkB2yUe6pFU/ohxyQLLmoxVkooS5ZTFZXlNlwihhLiiVh/P9cMcVnRW/VtwxRRhWzJTiQuMEKR+7oPRmReJH8QbhddrNC9GRApEF343DVUWc7y5iDfIVxZsavXhaxsbjK9MfXNfHKlmaj+D46v3pbVWo5wiJ+HCgehGxlOeQvA8QAo8rDq65ENaZMen13CO9rZ9pHMlLsiQp+j5AGZ38M3/36nVZVG0y8ElMxbh/NnQP+s+B/gW3UDTN+m1LRgAAAABJRU5ErkJggg=="
    />
  </head>
  <body>
    <!-- Cesium界面-->
    <link
      rel="stylesheet"
      href="./node_modules/cesium/Build/CesiumUnminified/Widgets/widgets.css"
    />
    <style>
      #container {
        position: absolute;
        width: 100%;
        height: 100%;
        left: 0;
        top: 0;
      }
    </style>
    <div id="container"></div>
    <script
      type="text/javascript"
      src="./node_modules/cesium/Build/CesiumUnminified/Cesium.js"
    ></script>
    <!-- 创建Cesium场景 -->
    <script type="text/javascript">
      const container = document.querySelector("#container");
      const viewer = new Cesium.Viewer(container, {
        baseLayerPicker: false,
        imageryProvider: new Cesium.ArcGisMapServerImageryProvider({
          url: "https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer",
        }),
      });
    </script>
    <!-- 添加模型 -->
    <script type="text/javascript">
      const tileset = new Cesium.Cesium3DTileset({
        url: "https://data.mars3d.cn/3dtiles/jzw-shanghai/tileset.json",
        // shadows: Cesium.ShadowMode.DISABLED,
        // lightColor: new Cesium.Cartesian3(1, 1, 1),''
        // showOutline: false,
      });
      viewer.scene.primitives.add(tileset);
    </script>
    <!-- 初始视角 -->
    <script type="text/javascript">
      // 使用模型视角
      // tileset.readyPromise.then(function (tileset) {
      //   viewer.camera.flyToBoundingSphere(tileset.boundingSphere, {
      //     duration: 0,
      //   });
      // });
      // 使用自定义视角
      viewer.camera.setView({
        destination: {
          x: -2851045.4074052866,
          y: 4654456.610110114,
          z: 3289122.790063821,
        },
        orientation: {
          heading: 1.9822013104933793,
          pitch: -0.47942367195068814,
          roll: 0.000004410721189174183,
        },
      });
    </script>
    <!-- 修改白模 -->
    <script type="text/javascript">
      /**
       * 修改白模颜色
       * @version v0.0.5
       * @param {Cesium.Cesium3DTileset} tileset
       * @param {string} cssColorString 形如“#fff”
       * @author 孙曙光 <jobsimi@qq.com>
       * @example
       * // 给白模应用颜色修改
       * let white3DTilesetStyle = new White3DTilesetStyle(tileset, "#fff");
       * // 还原白模的颜色修改
       * white3DTilesetStyle.destroy();
       * // 再次应用颜色修改
       * white3DTilesetStyle.apply();
       * // 修改为其他颜色
       * white3DTilesetStyle = new White3DTilesetStyle(tileset, "#000");
       */
      class White3DTilesetStyle {
        /**
         * @param {Cesium.Cesium3DTileset} tileset
         * @param {string} cssColorString 形如“#fff”
         */
        constructor(tileset, cssColorString) {
          this.tileset = tileset;
          this.cssColorString = cssColorString;
          this.isApply = false;
          this.initSetting = {};
          this.isLogedModelFragmentShader = false;
          this.apply();
        }
        /**
         * 还原白模颜色修改
         */
        destroy() {
          const { style } = this.initSetting;
          this.tileset.style = style;
          // 清除所有Listener
          this.tileset.tileVisible.removeEventListener(
            White3DTilesetStyle.prototype
              .replaceToTilesetModelLightFragmentShader
          );
          // 还原默认颜色
          this.tileset._selectedTiles.forEach(
            White3DTilesetStyle.prototype
              .replaceToTilesetModelDefaultFragmentShader
          );
        }
        logModelFragmentShaderOnce(tile) {
          const $this = this;
          White3DTilesetStyle.prototype.forEachTilesetModel(
            tile,
            function (model) {
              // 保存3DTileset原有的shader，便于还原。
              if ($this.isLogedModelFragmentShader === false) {
                $this.isLogedModelFragmentShader = true;
                console.log(
                  "fragmentShader",
                  model._rendererResources.sourceShaders[1]
                );
              }
            }
          );
        }
        /**
         * 应用白模颜色修改
         */
        apply() {
          const $this = this;
          this.initSetting.style = this.tileset.style; // 保存3DTileset原有的样式，便于还原。
          this.tileset.style = new Cesium.Cesium3DTileStyle({
            color: {
              conditions: [
                ["true", `color(${JSON.stringify(this.cssColorString)})`],
              ],
            },
          });
          // 清除所有Listener
          this.tileset.tileVisible.removeEventListener(
            White3DTilesetStyle.prototype
              .replaceToTilesetModelLightFragmentShader
          );
          // 根据颜色来添加Listener
          if (
            White3DTilesetStyle.prototype.isLightColor(this.cssColorString) ===
            true
          ) {
            this.tileset.tileVisible.addEventListener(
              White3DTilesetStyle.prototype
                .replaceToTilesetModelLightFragmentShader
            );
            // this.tileset.tileVisible.addEventListener(
            //   this.logModelFragmentShaderOnce
            // );
          } else {
            // 还原默认颜色
            this.tileset._selectedTiles.forEach(
              White3DTilesetStyle.prototype
                .replaceToTilesetModelDefaultFragmentShader
            );
          }
        }
      }
      /**
       * hex to rgb
       * ————————————————
       * 版权声明：本文为CSDN博主「mossbaoo」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。
       * 原文链接：https://blog.csdn.net/mossbaoo/article/details/93484635
       */
      White3DTilesetStyle.prototype.hexToRGB = function (hex) {
        // 16进制颜色值的正则
        const reg = /^#([0-9a-fA-f]{3}|[0-9a-fA-f]{6})$/;
        // 把颜色值变成小写
        let color = hex.toLowerCase();
        if (reg.test(color)) {
          // 如果只有三位的值，需变成六位，如：#fff => #ffffff
          if (color.length === 4) {
            let colorNew = "#";
            for (let i = 1; i < 4; i += 1) {
              colorNew += color.slice(i, i + 1).concat(color.slice(i, i + 1));
            }
            color = colorNew;
          }
          // 处理六位的颜色值，转为RGB
          const colorChange = [];
          for (let i = 1; i < 7; i += 2) {
            colorChange.push(parseInt("0x" + color.slice(i, i + 2)));
          }
          return colorChange;
        } else {
          return;
        }
      };
      /**
       * 是否是浅色
       * @see https://www.cnblogs.com/qinwei/p/6437800.html
       */
      White3DTilesetStyle.prototype.isLightColor = function (cssColorString) {
        const rgb = White3DTilesetStyle.prototype.hexToRGB(cssColorString);
        if (rgb === undefined) {
          return false;
        }
        const [r, g, b] = rgb;
        const grayLevel = r * 0.299 + g * 0.587 + b * 0.114;
        if (grayLevel >= 192) {
          return true;
        } else {
          return false;
        }
      };
      /**
       * 遍历每一个Tile的model
       */
      White3DTilesetStyle.prototype.forEachTilesetModel = function (
        tile,
        onModel
      ) {
        const content = tile.content;
        const featuresLength = content.featuresLength;
        for (let i = 0; i < featuresLength; i += 2) {
          let feature = content.getFeature(i);
          let model = feature.content._model;
          if (model && model._sourcePrograms && model._rendererResources) {
            onModel(model);
          }
        }
      };
      /**
       * 替换Tileset每个model的FragmentShader
       */
      White3DTilesetStyle.prototype.replaceTilesetModelFragmentShader =
        function (tile, from, to) {
          White3DTilesetStyle.prototype.forEachTilesetModel(
            tile,
            function (model) {
              Object.keys(model._sourcePrograms).forEach((key) => {
                let program = model._sourcePrograms[key];
                const { sourceShaders } = model._rendererResources;
                const fragmentShader = sourceShaders[program.fragmentShader];
                sourceShaders[program.fragmentShader] = fragmentShader.replace(
                  from,
                  to
                );
              });
              model._shouldRegenerateShaders = true;
            }
          );
        };
      /**
       * 默认的FragmentShader片段
       */
      White3DTilesetStyle.prototype.defaultFragmentShaderSlice = `return pow(linearIn, vec3(1.0/2.2));`;
      /**
       * 明亮的FragmentShader片段
       */
      White3DTilesetStyle.prototype.lightFragmentShaderSlice = `return pow(linearIn, vec3(1.0/10.1));`;
      /**
       * 替换为明亮的FragmentShader片段
       */
      White3DTilesetStyle.prototype.replaceToTilesetModelLightFragmentShader =
        function (tile) {
          White3DTilesetStyle.prototype.replaceTilesetModelFragmentShader(
            tile,
            White3DTilesetStyle.prototype.defaultFragmentShaderSlice,
            White3DTilesetStyle.prototype.lightFragmentShaderSlice
          );
        };
      White3DTilesetStyle.prototype.replaceToTilesetModelDefaultFragmentShader =
        function (tile) {
          White3DTilesetStyle.prototype.replaceTilesetModelFragmentShader(
            tile,
            White3DTilesetStyle.prototype.lightFragmentShaderSlice,
            White3DTilesetStyle.prototype.defaultFragmentShaderSlice
          );
        };
    </script>
    <script type="text/javascript">
      let white3DTilesetStyle = new White3DTilesetStyle(tileset, "#fff");
    </script>
  </body>
</html>
